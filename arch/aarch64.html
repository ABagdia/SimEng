

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>AArch64 &mdash; SimEng  documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> SimEng
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">User Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../user/index.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user/building_simeng.html">Building SimEng</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user/running_simeng.html">Running SimEng</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user/configuring_simeng.html">Configuring SimEng</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user/creating_binaries.html">Creating Binaries</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user/docker.html">Docker</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">SimEng</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>AArch64</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            
              <a href="https://github.com/UoB-HPC/SimEng/blob/master/arch/aarch64.rst" class="fa fa-github"> Edit on GitHub</a>
            
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="aarch64">
<h1><a class="toc-backref" href="#id1">AArch64</a><a class="headerlink" href="#aarch64" title="Permalink to this headline">¶</a></h1>
<p>SimEng provides a basic implementation of the 64-bit AArch64 architecture—part of the ARMv8-a ISA. This implementation provides support for decoding and executing a range of common instructions, sufficient to run a number of simple benchmarks. It is also capable of handling supervisor call (syscall) exception via basic system call emulation, allowing the execution of programs that have been statically compiled with the standard library.</p>
<div class="contents topic" id="contents">
<p class="topic-title">Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#aarch64" id="id1">AArch64</a></p>
<ul>
<li><p><a class="reference internal" href="#decoding" id="id2">Decoding</a></p></li>
<li><p><a class="reference internal" href="#adding-instructions" id="id3">Adding instructions</a></p>
<ul>
<li><p><a class="reference internal" href="#adding-execution-behaviour" id="id4">Adding execution behaviour</a></p>
<ul>
<li><p><a class="reference internal" href="#cstool" id="id5">cstool</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#zero-registers" id="id6">Zero registers</a></p></li>
<li><p><a class="reference internal" href="#loads-and-stores" id="id7">Loads and stores</a></p></li>
<li><p><a class="reference internal" href="#instruction-aliases" id="id8">Instruction aliases</a></p></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="decoding">
<h2><a class="toc-backref" href="#id2">Decoding</a><a class="headerlink" href="#decoding" title="Permalink to this headline">¶</a></h2>
<p>Instruction decoding is performed using the <a class="reference external" href="https://github.com/aquynh/capstone/">Capstone</a> disassembly framework. The disassembly generated by Capstone is used to determine the properties, operands, and execution behaviour of the corresponding instruction.</p>
</div>
<div class="section" id="adding-instructions">
<h2><a class="toc-backref" href="#id3">Adding instructions</a><a class="headerlink" href="#adding-instructions" title="Permalink to this headline">¶</a></h2>
<p>Due to the vast number of AArch64 instruction variants, instructions are only added to this architecture as encountered in programs using them; as a result, to run a new program it will likely be necessary to add support for a number of instructions.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>When adding support for new instructions, it’s recommended to run SimEng in emulation mode for both speed, and for an execution flow that’s easier to follow.</p>
</div>
<p>When you first run the new program through SimEng, execution will occur as normal until an unsupported instruction reaches the retirement point. This will then generate an illegal instruction exception, which the architecture will catch and provide useful output before terminating. An example of the expected output is below:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Encountered</span> <span class="n">execution</span> <span class="ow">not</span><span class="o">-</span><span class="n">yet</span><span class="o">-</span><span class="n">implemented</span> <span class="n">exception</span>
  <span class="n">Generated</span> <span class="n">by</span> <span class="n">instruction</span><span class="p">:</span>
    <span class="mh">0x00000000004004a8</span><span class="p">:</span> <span class="n">f3</span> <span class="mi">0</span><span class="n">f</span> <span class="mi">1</span><span class="n">e</span> <span class="n">f8</span>     <span class="nb">str</span> <span class="n">x19</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="c1">#-0x20]!</span>
      <span class="n">opcode</span> <span class="n">ID</span><span class="p">:</span> <span class="mi">1920</span>
<span class="n">Halting</span> <span class="n">due</span> <span class="n">to</span> <span class="n">fatal</span> <span class="n">exception</span>
</pre></div>
</div>
<p>This information includes the program address of the unrecognised instruction, the bytes of the encoded instruction, and the textual representation of the instruction. An “opcode ID” is also provided: this corresponds to a specific value in the <code class="docutils literal notranslate"><span class="pre">simeng::arch::aarch64::Opcode</span></code> namespace, imported from Capstone.</p>
<div class="section" id="adding-execution-behaviour">
<h3><a class="toc-backref" href="#id4">Adding execution behaviour</a><a class="headerlink" href="#adding-execution-behaviour" title="Permalink to this headline">¶</a></h3>
<p>The first step to add a new instruction (and the only, for many instructions) is to add a new entry into the execution behaviour table found in <code class="docutils literal notranslate"><span class="pre">src/lib/arch/aarch64/Instruction_execute.cc</span></code>. These entries are responsible for reading the input operands and generating one or more results which may be read by the model handling the instruction. The entry should be uniquely identified by the namespace entry corresponding to the opcode ID presented by SimEng when the unsupported instruction was encountered.</p>
<p>There are several useful variables that execution behaviours have access to:</p>
<dl>
<dt><code class="docutils literal notranslate"><span class="pre">operands</span></code></dt><dd><p>This is a vector of <code class="docutils literal notranslate"><span class="pre">RegisterValue</span></code>, with each value corresponding to one of the input operands. For most instructions, <code class="docutils literal notranslate"><span class="pre">operands[0]</span></code> will be the <em>second</em> operand as written textually, as the first operand is typically the destination register. E.g., for the instruction <code class="docutils literal notranslate"><span class="pre">add</span> <span class="pre">w0,</span> <span class="pre">w1,</span> <span class="pre">w2</span></code>, <code class="docutils literal notranslate"><span class="pre">operands[0]</span></code> will correspond to <code class="docutils literal notranslate"><span class="pre">w1</span></code> and <code class="docutils literal notranslate"><span class="pre">[1]</span></code> to <code class="docutils literal notranslate"><span class="pre">w2</span></code>.</p>
<p>Some instructions have “implicit” register reads: these are added to the <strong>start</strong> of the operand array. E.g., the instruction <code class="docutils literal notranslate"><span class="pre">b.ne</span> <span class="pre">#16</span></code> implicitly reads the “NZCV” flags. In this case, <code class="docutils literal notranslate"><span class="pre">operands[0]</span></code> will be the value of the flag register.</p>
<p>Some instructions have operands to which they both read and write, such as <code class="docutils literal notranslate"><span class="pre">fmla</span> <span class="pre">v0.d,</span> <span class="pre">v1.d,</span> <span class="pre">v2.d</span></code> both writing to <em>and</em> reading from <code class="docutils literal notranslate"><span class="pre">v0.d</span></code>; in this case, <code class="docutils literal notranslate"><span class="pre">operands[0]</span></code> is <code class="docutils literal notranslate"><span class="pre">v0.d</span></code>, and <code class="docutils literal notranslate"><span class="pre">[1]</span></code> and <code class="docutils literal notranslate"><span class="pre">[2]</span></code> are <code class="docutils literal notranslate"><span class="pre">v1.d</span></code> and <code class="docutils literal notranslate"><span class="pre">v2.d</span></code> respectively.</p>
<p>Instructions such as stores may not have any destination registers at all. In these cases, the <code class="docutils literal notranslate"><span class="pre">operand</span></code> indices match the positions as they appear: the first operand is <code class="docutils literal notranslate"><span class="pre">[0]</span></code>, the second <code class="docutils literal notranslate"><span class="pre">[1]</span></code>, and so on.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">results</span></code></dt><dd><p>This is the output vector, into which <code class="docutils literal notranslate"><span class="pre">RegisterValue</span></code> instances containing the results should be placed. Each entry in the vector corresponds to a destination register.</p>
<p>Some instructions have “implicit” destination registers: in these cases, the implicit destinations are added to the start of the results vector. For example, <code class="docutils literal notranslate"><span class="pre">subs</span> <span class="pre">w0,</span> <span class="pre">w1,</span> <span class="pre">#1</span></code> writes explicitly to <code class="docutils literal notranslate"><span class="pre">w0</span></code>, but also implicitly sets the “NZCV” comparison flags. In this case, <code class="docutils literal notranslate"><span class="pre">results[0]</span></code> is expected to be the updated NZCV flags, while <code class="docutils literal notranslate"><span class="pre">results[1]</span></code> is expected to be the new value of <code class="docutils literal notranslate"><span class="pre">w0</span></code>.</p>
<p>Memory instructions may have a “writeback” variant, where the register containing the address is updated by an offset during execution. In these cases, the address register is added as a destination <em>after</em> the other registers, corresponding with the textual representation of the registers. E.g., the instruction <code class="docutils literal notranslate"><span class="pre">ldr</span> <span class="pre">x1,</span> <span class="pre">[x2,</span> <span class="pre">#8]!</span></code> will expect the value of <code class="docutils literal notranslate"><span class="pre">x1</span></code> in <code class="docutils literal notranslate"><span class="pre">results[0]</span></code>, while the updated address <code class="docutils literal notranslate"><span class="pre">x2</span></code> should be placed in <code class="docutils literal notranslate"><span class="pre">results[1]</span></code>.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">metadata</span></code></dt><dd><p>Each instruction stores a simplified form of the full disassembly metadata generated by Capstone. This is stored in the <code class="docutils literal notranslate"><span class="pre">metadata</span></code> member variable, and is of type <code class="docutils literal notranslate"><span class="pre">InstructionMetadata</span></code>. The metadata object contains an <code class="docutils literal notranslate"><span class="pre">metadata.operands</span></code> array with entries corresponding to the textual operands of the instruction. <strong>Note:</strong> Unlike the instruction’s <code class="docutils literal notranslate"><span class="pre">operands</span></code> member variable, <code class="docutils literal notranslate"><span class="pre">metadata.operands</span></code> entries correspond directly to their textual equivalent. For example, in the instruction <code class="docutils literal notranslate"><span class="pre">add</span> <span class="pre">w0,</span> <span class="pre">w1,</span> <span class="pre">w2</span></code>, <code class="docutils literal notranslate"><span class="pre">metadata.operands[0]</span></code> will describe <code class="docutils literal notranslate"><span class="pre">w0</span></code>, <code class="docutils literal notranslate"><span class="pre">[1]</span></code> describes <code class="docutils literal notranslate"><span class="pre">w1</span></code>, and so on.</p>
<p>The primary use for this data is to retrieve immediate values. For example, with the instruction <code class="docutils literal notranslate"><span class="pre">add</span> <span class="pre">w0,</span> <span class="pre">w1,</span> <span class="pre">#1</span></code>, <code class="docutils literal notranslate"><span class="pre">metadata.operands[2].imm</span></code> would contain the value <code class="docutils literal notranslate"><span class="pre">1</span></code>. Floating-point immediates are similarly available, using <code class="docutils literal notranslate"><span class="pre">.fp</span></code> in place of <code class="docutils literal notranslate"><span class="pre">.imm</span></code>.</p>
<p>For memory operations, the <em>entire</em> memory address section is treated as a single <code class="docutils literal notranslate"><span class="pre">metadata.operands</span></code> entry, with information available under <code class="docutils literal notranslate"><span class="pre">metadata.operands[n].mem</span></code>. For example, for the instruction <code class="docutils literal notranslate"><span class="pre">ldr</span> <span class="pre">x0,</span> <span class="pre">[sp,</span> <span class="pre">#8]</span></code>, <code class="docutils literal notranslate"><span class="pre">metadata.operands[1].mem</span></code> contains information on the <code class="docutils literal notranslate"><span class="pre">[sp,</span> <span class="pre">#8]</span></code> block, with <code class="docutils literal notranslate"><span class="pre">metadata.operands[1].mem.disp</span></code> containing the specified offset of <code class="docutils literal notranslate"><span class="pre">8</span></code>.</p>
</dd>
</dl>
<div class="section" id="cstool">
<h4><a class="toc-backref" href="#id5">cstool</a><a class="headerlink" href="#cstool" title="Permalink to this headline">¶</a></h4>
<p>Capstone provides a <code class="docutils literal notranslate"><span class="pre">cstool</span></code> utility, which provides a visual representation of the <code class="docutils literal notranslate"><span class="pre">metadata</span></code> information available for any given instruction. For example, feeding it the bytes for the <code class="docutils literal notranslate"><span class="pre">str</span></code> instruction displayed above results in the following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ cstool -d arm64 f30f1ef8
 0  f3 0f 1e f8  str    x19, [sp, #-0x20]!
        op_count: 2
                operands[0].type: REG = x19
                operands[0].access: READ
                operands[1].type: MEM
                        operands[1].mem.base: REG = sp
                        operands[1].mem.disp: 0xffffffe0
                operands[1].access: READ | WRITE
        Write-back: True
        Registers read: x19 sp
        Registers modified: sp
</pre></div>
</div>
</div>
</div>
<div class="section" id="zero-registers">
<h3><a class="toc-backref" href="#id6">Zero registers</a><a class="headerlink" href="#zero-registers" title="Permalink to this headline">¶</a></h3>
<p>AArch64 provides two zero registers, <code class="docutils literal notranslate"><span class="pre">WZR</span></code> and <code class="docutils literal notranslate"><span class="pre">XZR</span></code>, which are always read as 0. This implementation mirrors that behaviour, and will automatically populate the relevant <code class="docutils literal notranslate"><span class="pre">operands</span></code> entry with a 0-value <code class="docutils literal notranslate"><span class="pre">RegisterValue</span></code>.</p>
<p>For instructions that are capable of generating multiple results (typically flag-setting instructions) it’s possible for them to claim to write to one of the zero registers: in these cases, the result is discarded. This implementation supports this behaviour, and reduces the number of available <code class="docutils literal notranslate"><span class="pre">results</span></code> entries accordingly.</p>
</div>
<div class="section" id="loads-and-stores">
<h3><a class="toc-backref" href="#id7">Loads and stores</a><a class="headerlink" href="#loads-and-stores" title="Permalink to this headline">¶</a></h3>
<p>In addition to an execution behaviour, memory instructions also require a new entry in the address generation behaviour table found in <code class="docutils literal notranslate"><span class="pre">src/lib/arch/aarch64/Instruction_address.cc</span></code>. These entries are responsible for describing the method used to generate the addresses that these instructions will read from or write to.</p>
<p>Address generation is expected to generate one or more instances of <code class="docutils literal notranslate"><span class="pre">MemoryAddressTarget</span></code>, containing an address and the number of bytes to access. The same variables described above (<code class="docutils literal notranslate"><span class="pre">operands</span></code>, <code class="docutils literal notranslate"><span class="pre">metadata</span></code>) are available to use to generate these addresses.</p>
<p>Once the addresses have been generated, they should be supplied in an initialiser list to the <code class="docutils literal notranslate"><span class="pre">setMemoryAddresses</span></code> helper function.</p>
</div>
<div class="section" id="instruction-aliases">
<h3><a class="toc-backref" href="#id8">Instruction aliases</a><a class="headerlink" href="#instruction-aliases" title="Permalink to this headline">¶</a></h3>
<p>As Capstone is primarily a disassembler, it will attempt to generate the correct aliases for instructions: for example, the <code class="docutils literal notranslate"><span class="pre">cmp</span> <span class="pre">w0,</span> <span class="pre">#0</span></code> instruction is an alias for <code class="docutils literal notranslate"><span class="pre">subs</span> <span class="pre">wzr,</span> <span class="pre">w0,</span> <span class="pre">#0</span></code>. As it’s the underlying instruction that is of use (in this case, the <code class="docutils literal notranslate"><span class="pre">subs</span></code> instruction), this implementation includes a de-aliasing component that reverses this conversion. The logic for this may be found in <code class="docutils literal notranslate"><span class="pre">src/lib/arch/aarch64/InstructionMetadata</span></code>.</p>
<p>If a known but unsupported alias is encountered, it will generate an invalid instruction error, and the output will identify the instruction as unknown in place of the usual textual representation. It is recommended to reference a disassembled version of the program to identify what the instruction at this address should be correctly disassembled to, and implement the necessary dealiasing logic accordingly.</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021, SimEng developers.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>